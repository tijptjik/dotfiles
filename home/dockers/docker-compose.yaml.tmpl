{{ if .isServer -}}

x-common-env: &common-env
  PUID: 1000
  PGID: 950
  TZ: Asia/Hong_Kong

services:

##################################
###  AA - ACQUISTION SERVICES  ###
##################################

########################
###  MOVIES / SHOWS  ###
########################

########################
###  RADARR          ###
###  movies.type.hk  ###
########################

  radarr:
    container_name: radarr
    image: linuxserver/radarr:latest
    restart: unless-stopped
    depends_on:
      transmission:
        condition: service_healthy
    logging:
      driver: json-file
    environment:
      <<: *common-env
    ports:
      - {{ .ports.radarr }}:{{ .ports.radarr }}
    volumes:
      - {{ .paths.appData }}/radarr:/config
      - /mnt/storage:/data
      - /etc/localtime:/etc/localtime:ro

#######################
###  SONARR         ###
###  shows.type.hk  ###
#######################

  sonarr:
    container_name: sonarr
    image: linuxserver/sonarr:latest
    restart: unless-stopped
    depends_on:
      transmission:
        condition: service_healthy
    logging:
      driver: json-file
    environment:
      <<: *common-env
    ports:
      - {{ .ports.sonarr }}:{{ .ports.sonarr }}
    volumes:
      - {{ .paths.appData }}/sonarr:/config
      - /mnt/storage:/data
      - /etc/localtime:/etc/localtime:ro

####################################
###  BOOKS / MAGAZINES / COMICS  ###
####################################

#######################
###  READARR        ###
###  books.type.hk  ###
#######################

  bookshelf:
    container_name: bookshelf
    image: ghcr.io/pennydreadful/bookshelf:hardcover
    restart: unless-stopped
    depends_on:
      transmission:
        condition: service_healthy
    environment:
      <<: *common-env
    ports:
      - {{ .ports.bookshelf }}:{{ .ports.bookshelf }}
    volumes:
      - {{ .paths.appData }}/bookshelf:/config
      - {{ .paths.publicRoot }}/books:{{ .paths.publicRoot }}/books
      - {{ .paths.publicRoot }}/library:{{ .paths.publicRoot }}/library
      - {{ .paths.downloads }}:{{ .paths.downloads }}
      - /opt:/opt

######################
###  EPHEMERA      ###
###  anna.type.hk  ###
######################

  ephemera:
    container_name: ephemera
    image: ghcr.io/orwellianepilogue/ephemera:latest
    restart: unless-stopped
    environment:
      <<: *common-env
      # FlareSolverr URL (for slow download fallback)
      FLARESOLVERR_URL: http://flaresolverr:{{ .ports.byparr }}
      AA_BASE_URL: https://annas-archive.li/
      ALLOWED_ORIGINS: https://ephemera.type.hk
    ports:
      - {{ .ports.ephemera }}:{{ .ports.ephemera }}
    volumes:
      - {{ .paths.appData }}/ephemera:/app/data
      - {{ .paths.downloads }}/ephemera:{{ .paths.downloads }}/ephemera
      - {{ .paths.downloads }}/bookdrop:{{ .paths.downloads }}/bookdrop
      - {{ .paths.publicRoot }}/library:{{ .paths.publicRoot }}/library

######################
###  SHELFMARK     ###
###  mark.type.hk  ###
######################

  shelfmark:
    container_name: shelfmark
    image: ghcr.io/calibrain/shelfmark:latest
    restart: unless-stopped
    environment:
      <<: *common-env
    ports:
     - {{ .ports.shelfmark }}:{{ .ports.shelfmark }}
    volumes:
      - {{ .paths.appData }}/shelfmark:/config # App configuration
      - {{ .paths.downloads }}/bookdrop:/books
      - {{ .paths.downloads }}/absdrop:/audiobooks
      # Download client mount - path must match your torrent/usenet client's volume exactly
      - {{ .paths.downloads }}:{{ .paths.downloads }}

########################
###  LAZY LIBRARIAN  ###
###  liz.type.hk     ###
########################

  lazylibrarian:
    container_name: lazylibrarian
    image: linuxserver/lazylibrarian:latest
    restart: unless-stopped
    depends_on:
      transmission:
        condition: service_healthy
    environment:
      <<: *common-env
      DOCKER_MODS: linuxserver/mods:universal-calibre|linuxserver/mods:lazylibrarian-ffmpeg
    ports:
      - {{ .ports.lazylibrarian }}:{{ .ports.lazylibrarian }}
    volumes:
      - {{ .paths.appData }}/lazylibrarian:/config
      - {{ .paths.downloads }}:/downloads
      - {{ .paths.downloads }}:{{ .paths.downloads }}
      - {{ .paths.publicRoot }}/library:/books
      - {{ .paths.publicRoot }}/library:{{ .paths.publicRoot }}/library

###############
###  MUSIC  ###
###############

#######################
###  LIDARR         ###
###  music.type.hk  ###
#######################

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    restart: unless-stopped
    depends_on:
      transmission:
        condition: service_healthy
    environment:
      <<: *common-env
    ports:
      - {{ .ports.lidarr }}:{{ .ports.lidarr }}
    volumes:
      - {{ .paths.appData }}/lidarr:/config
      - {{ .paths.publicRoot }}/music:/music
      - {{ .paths.downloads }}:{{ .paths.downloads }}
      - {{ .paths.downloads }}:/downloads

##################################
###  AA - STREAMING SERVICES   ###
##################################

#######################
###  PLEX           ###
###  watch.type.hk  ###
###  TODO           ###
#######################

####################################
###  BOOKS / MAGAZINES / COMICS  ###
####################################

######################
###  BOOKLORE      ###
###  read.type.hk  ###
######################

  booklore:
    container_name: booklore
    image: booklore/booklore:latest
    restart: unless-stopped
    depends_on:
      mariadb:
        condition: service_healthy
    healthcheck:
      test: wget -q -O - http://localhost:{{ .ports.booklore }}/api/v1/healthcheck
      interval: 60s
      retries: 5
      start_period: 60s
      timeout: 10s
    environment:
      USER_ID: 1000
      GROUP_ID: 950
      TZ: Asia/Hong_Kong
      DATABASE_URL: jdbc:mariadb://mariadb:{{ .ports.mariadb }}/booklore
      DATABASE_USERNAME: booklore
      DATABASE_PASSWORD: {{ (bitwardenSecrets "3346efb5-9036-417a-a4ae-b3cb00a7011c").value | quote }}
      PORT_BOOKLORE: {{ .ports.booklore }}
    ports:
      - {{ .ports.booklore }}:{{ .ports.booklore }}
    volumes:
      - {{ .paths.appData }}/booklore:/app/data
      - {{ .paths.downloads }}/bookdrop:/bookdrop
      - {{ .paths.publicRoot }}/library/stars:/books
      - {{ .paths.publicRoot }}/library:/library

######################
# DEPRECATED       ###
###  CALIBRE       ###
###  book.type.hk  ###
######################

  calibre-web:
    container_name: calibre-web
    image: linuxserver/calibre-web:latest
    restart: unless-stopped
    environment:
      <<: *common-env
      DOCKER_MODS: linuxserver/mods:universal-calibre
      OAUTHLIB_RELAX_TOKEN_SCOPE: 1
    ports:
      - {{ .ports.calibre }}:{{ .ports.calibre }}
    volumes:
      - {{ .paths.publicRoot }}/calibre-web:/config
      - {{ .paths.publicRoot }}/books/EN:/books

##############################
###  AUDIOBOOKS / PODCASTS ###
##############################

########################
###  AUDIOBOOKSHELF  ###
###  listen.type.hk  ###
########################

  audiobookshelf:
    container_name: audiobookshelf
    image: ghcr.io/advplyr/audiobookshelf:latest
    restart: unless-stopped
    environment:
      <<: *common-env
    ports:
      - {{ .ports.audiobookshelf }}:80
    volumes:
      - {{ .paths.publicRoot }}/audiobooks:/audiobooks
      - {{ .paths.downloads }}/absdrop:/absdrop
      - {{ .paths.publicRoot }}/podcasts:/podcasts
      - {{ .paths.appData }}/audiobookshelf:/config
      - {{ .paths.appCache }}/audiobookshelf:/metadata

###############
###  MUSIC  ###
###############

####################
###  NAVIDROME   ###
###  dj.type.hk  ###
####################

  navidrome:
    container_name: navidrome
    image: deluan/navidrome:latest
    user: 1000:950
    restart: unless-stopped
    environment:
      ND_LOGLEVEL: info
      ND_BASEURL: https://dj.type.hk
      ND_LASTFM_APIKEY: 82389b3a3f3c3aabae41a323c9982491
      ND_LASTFM_SECRET: "{{ (bitwardenSecrets "bf38b38f-73de-4da1-bf89-b3d70089f4af").value }}"
      ND_SPOTIFY_ID: b39517108586443382efc09fcf0fd0a7
      ND_SPOTIFY_SECRET: "{{ (bitwardenSecrets "29598444-cf58-448d-a7bf-b3d7008a937f").value }}"
    ports:
      - {{ .ports.navidrome }}:{{ .ports.navidrome }}
    volumes:
      - {{ .paths.appData }}/navidrome:/data
      - {{ .paths.publicRoot }}/music:/music:ro

#######################
###  FEISHIN        ###
###  dance.type.hk  ###
#######################

  feishin:
    container_name: feishin
    image: 'ghcr.io/jeffvli/feishin:latest'
    restart: unless-stopped
    environment:
      SERVER_NAME: Astral Archive # pre-defined server name
      SERVER_LOCK: true # When true AND name/type/url are set, only username/password can be toggled
      SERVER_TYPE: navidrome # the allowed types are: jellyfin, navidrome, subsonic. These values are case insensitive
      SERVER_URL: https://dj.type.hk # the URL to http://address:port or https://address:port
      LEGACY_AUTHENTICATION: false # When SERVER_LOCK is true, sets the legacy (plaintext) authentication flag for Subsonic/OpenSubsonic servers
      ANALYTICS_DISABLED: false # Set to true to disable Umami analytics tracking
    ports:
      - {{ .ports.feishin }}:{{ .ports.feishin }}

####################
###  AA - TOOLS  ###
####################

#################################
###  MONITORING / DASHBOARDS  ###
#################################

#########################
###  TAUTULLI         ###
###  monitor.type.hk  ###
#########################

  tautulli:
    container_name: tautulli
    image: linuxserver/tautulli:latest
    restart: unless-stopped
    environment:
      <<: *common-env
    volumes:
      - /mnt/storage/meta/appData/tautulli:/config
    ports:
      - {{ .ports.tautulli }}:{{ .ports.tautulli }}

#########################
###  PLEX REWIND      ###
###  wrapped.type.hk  ###
#########################

  plex-rewind:
    image: ghcr.io/raunot/plex-rewind:latest # :develop for the latest development version
    container_name: plex-rewind
    restart: unless-stopped
    environment:
      - NEXTAUTH_SECRET=l50akmhIBl4TRgE3OCUOn0SO+6oAe4UvyU2VKhOYodA=
      - NEXTAUTH_URL=http://wrapped.type.hk
      - NEXT_PUBLIC_SITE_URL=http://wrapped.type.hk
    volumes:
      - {{ .paths.appData }}/plexrewind:/app/config
    ports:
      - {{ .ports.plexRewind }}:{{ .ports.plexRewind }}

##################
###  INDEXERS  ###
##################

#########################
###  PROWLARR         ###
###  indexer.type.hk  ###
#########################

  prowlarr:
    container_name: prowlarr
    image: bitlessbyte/prowlarr:latest
    restart: unless-stopped
    environment:
      <<: *common-env
    ports:
      - {{ .ports.prowlarr }}:{{ .ports.prowlarr }}
    volumes:
      - {{ .paths.appData }}/prowlarr:/config

#####################
###  DOWNLOADERS  ###
#####################

#########################
###  TRANSMISSION     ###
###  torrent.type.hk  ###
#########################

  transmission:
    container_name: transmission
    image: linuxserver/transmission:latest
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'curl -sf http://localhost:{{ .ports.transmissionWeb }} || [ $? -eq 22 ]']
      interval: 30s
      timeout: 10s
      retries: 5
    environment:
      <<: *common-env
      USER: media
      PASS: "{{ (bitwardenSecrets "d0001509-175f-4cef-9ca6-b3cb00abff89").value }}"
    volumes:
      - {{ .paths.appData }}/transmission:/config
      - {{ .paths.downloads }}:/downloads
      - {{ .paths.downloads }}/.torrents:/watch
      - /mnt/storage:/data
      - /etc/localtime:/etc/localtime:ro
    ports:
      - {{ .ports.transmissionWeb }}:{{ .ports.transmissionWeb }}
      - {{ .ports.transmissionP2P }}:{{ .ports.transmissionP2P }}
      - {{ .ports.transmissionP2P }}:{{ .ports.transmissionP2P }}/udp

#########################
###  CAPTCHA SOLVERS  ###
#########################

########################
###  BYPARR          ###
###  solver.type.hk  ###
########################

  byparr:
    container_name: byparr
    image: ghcr.io/thephaseless/byparr:latest
    restart: unless-stopped
    environment:
      <<: *common-env
      LOG_LEVEL: INFO
    ports:
      - {{ .ports.byparr }}:{{ .ports.byparr }}

###############################
###  FLARESOLVER            ###
###  http://localhost:8192  ###
###############################

  flaresolverr:
    container_name: flaresolverr
    image: ghcr.io/flaresolverr/flaresolverr:latest
    restart: unless-stopped
    environment:
      <<: *common-env
      LOG_LEVEL: info
      LOG_HTML: false
      CAPTCHA_SOLVER: none
    ports:
      - {{ .ports.flaresolverr }}:{{ .ports.byparr }}

##################
###  METADATA  ###
##################

###############################
###  BEETS                  ###
###  http://localhost:8337  ###
###############################

  beets:
    container_name: beets
    image: lscr.io/linuxserver/beets:latest
    restart: unless-stopped
    environment:
      <<: *common-env
    ports:
      - {{ .ports.beets }}:{{ .ports.beets }}
    volumes:
      - {{ .paths.appData }}/beets:/config
      - {{ .paths.publicRoot }}/music/releases:/music
      - {{ .paths.downloads }}/beetsdrop:/downloads

##########################################
###  BEETS : AUDIBLE                   ###
###  docker exec -it beets-audible sh  ###
##########################################

  beets-audible:
    container_name: beets-audible
    image: linuxserver/beets:latest
    restart: unless-stopped
    environment:
      <<: *common-env
    volumes:
      - {{ .paths.appData }}/beets-audible:/config
      - {{ .paths.appData }}/beets-audible/beets/scripts:/config/custom-cont-init.d
      - {{ .paths.publicRoot }}/audiobooks:/audiobooks
      - {{ .paths.downloads }}/audiobooks/untagged:/untagged

####################
###  CONVERTERS  ###
####################

####################
###  AUTO-M4B    ###
###  > headless  ###
####################

  auto-m4b:
    container_name: auto-m4b
    image: seanap/auto-m4b
    environment:
      <<: *common-env
      CPU_CORES: 4
      SLEEPTIME: 1m
      MAKE_BACKUP: "N"
    volumes:
      - {{ .paths.appData }}/auto-m4b:/config
      - {{ .paths.downloads }}/audiobooks:/temp

###################
###  DATABASES  ###
###################

####################
###  MARIADB     ###
###  > headless  ###
####################

  mariadb:
    container_name: mariadb
    image: linuxserver/mariadb:latest
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "mariadb-admin", "ping", "-h", "localhost" ]
      interval: 5s
      timeout: 5s
      retries: 10
    environment:
      <<: *common-env
      MYSQL_ROOT_PASSWORD: {{ (bitwardenSecrets "3b590574-69c0-44aa-a260-b3cb00bc810d").value | quote }}
      MYSQL_DATABASE: booklore
      MYSQL_USER: booklore
      MYSQL_PASSWORD: {{ (bitwardenSecrets "3346efb5-9036-417a-a4ae-b3cb00a7011c").value | quote }}
    ports:
      - {{ .ports.mariadb }}:{{ .ports.mariadb }}
    volumes:
      - /appData/mariadb/config:/config:z
{{ end -}}
